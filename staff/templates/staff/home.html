{% extends "staff/base.html" %}

{% block title %}Overview · Staff Dashboard{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}
{% block page_description %}Monitor lost and found items activity{% endblock %}

{% block content %}
<!-- Stats Cards Row 1 -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">Total Items</p>
        <p class="text-3xl font-bold text-amherst-purple">{{ total_items }}</p>
      </div>
      <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-archive text-blue-600 text-xl"></i>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">Active Items</p>
        <p class="text-3xl font-bold text-green-600">{{ active_items }}</p>
      </div>
      <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-check-circle text-green-600 text-xl"></i>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">This Week</p>
        <p class="text-3xl font-bold text-amherst-purple">{{ items_this_week }}</p>
      </div>
      <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-calendar-week text-amherst-purple text-xl"></i>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">With AI Recognition</p>
        <p class="text-3xl font-bold text-orange-600">{{ items_with_ai }}</p>
      </div>
      <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-robot text-orange-600 text-xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- Status Breakdown -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Lost Items</h3>
      <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm font-medium">{{ lost_items }}</span>
    </div>
    <div class="flex items-center">
      <div class="w-full bg-gray-200 rounded-full h-2 mr-4">
        {% if active_items > 0 %}
        <div class="bg-red-500 h-2 rounded-full" style="width: {% widthratio lost_items active_items 100 %}%"></div>
        {% endif %}
      </div>
      <span class="text-sm text-gray-600">{% if active_items > 0 %}{% widthratio lost_items active_items 100 %}{% else %}0{% endif %}%</span>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Found Items</h3>
      <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm font-medium">{{ found_items }}</span>
    </div>
    <div class="flex items-center">
      <div class="w-full bg-gray-200 rounded-full h-2 mr-4">
        {% if active_items > 0 %}
        <div class="bg-green-500 h-2 rounded-full" style="width: {% widthratio found_items active_items 100 %}%"></div>
        {% endif %}
      </div>
      <span class="text-sm text-gray-600">{% if active_items > 0 %}{% widthratio found_items active_items 100 %}{% else %}0{% endif %}%</span>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Returned Items</h3>
      <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-medium">{{ returned_items }}</span>
    </div>
    <div class="flex items-center">
      <div class="w-full bg-gray-200 rounded-full h-2 mr-4">
        {% if active_items > 0 %}
        <div class="bg-blue-500 h-2 rounded-full" style="width: {% widthratio returned_items active_items 100 %}%"></div>
        {% endif %}
      </div>
      <span class="text-sm text-gray-600">{% if active_items > 0 %}{% widthratio returned_items active_items 100 %}{% else %}0{% endif %}%</span>
    </div>
  </div>
</div>

<!-- Charts and Lists Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Top Locations -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
        <i class="fas fa-map-marker-alt text-amherst-purple"></i>
        Top Locations
      </h3>
    </div>
    <div class="p-6">
      {% for stat in location_stats %}
        <div class="flex items-center justify-between py-3 {% if not forloop.last %}border-b border-gray-100{% endif %}">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-amherst-purple rounded-full flex items-center justify-center text-white text-sm font-bold">
              {{ forloop.counter }}
            </div>
            <span class="font-medium text-gray-900">{{ stat.location__name|default:"Unknown Location" }}</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-16 bg-gray-200 rounded-full h-2">
              {% if location_stats and location_stats.0.count > 0 %}
              <div class="bg-amherst-purple h-2 rounded-full" style="width: {% widthratio stat.count location_stats.0.count 100 %}%"></div>
              {% endif %}
            </div>
            <span class="text-sm font-semibold text-gray-600">{{ stat.count }}</span>
          </div>
        </div>
      {% empty %}
        <p class="text-gray-500 text-center py-8">No location data available</p>
      {% endfor %}
    </div>
  </div>

  <!-- Top Reporters -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
        <i class="fas fa-users text-amherst-purple"></i>
        Top Reporters
      </h3>
    </div>
    <div class="p-6">
      {% for reporter in top_reporters %}
        <div class="flex items-center justify-between py-3 {% if not forloop.last %}border-b border-gray-100{% endif %}">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
              {{ forloop.counter }}
            </div>
            <div>
              <span class="font-medium text-gray-900">
                {% if reporter.reported_by__first_name %}
                  {{ reporter.reported_by__first_name }} {{ reporter.reported_by__last_name }}
                {% else %}
                  {{ reporter.reported_by__username }}
                {% endif %}
              </span>
              <p class="text-xs text-gray-500">@{{ reporter.reported_by__username }}</p>
            </div>
          </div>
          <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm font-medium">{{ reporter.count }}</span>
        </div>
      {% empty %}
        <p class="text-gray-500 text-center py-8">No reporter data available</p>
      {% endfor %}
      
      {% if anonymous_reports %}
      <div class="mt-4 pt-4 border-t border-gray-200">
        <div class="flex items-center justify-between">
          <span class="text-sm text-gray-600 flex items-center gap-2">
            <i class="fas fa-user-secret text-gray-400"></i>
            Anonymous Reports
          </span>
          <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-sm font-medium">{{ anonymous_reports }}</span>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Monthly Trends -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8">
  <div class="px-6 py-4 border-b border-gray-200">
    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
      <i class="fas fa-chart-line text-amherst-purple"></i>
      Monthly Trends (Last 6 Months)
    </h3>
  </div>
  <div class="p-6">
    <div class="flex items-end justify-between h-32 gap-2">
      {% for month in monthly_trends %}
        {% if forloop.first %}
          <!-- Store the max value for percentage calculations -->
          <script>var maxMonthlyCount = {{ month.count }};</script>
        {% endif %}
        <div class="flex flex-col items-center flex-1">
          <div class="w-full bg-amherst-purple rounded-t flex items-end justify-center text-white text-xs font-medium"
               style="height: {% if month.count > 0 %}{% widthratio month.count 50 100 %}px{% else %}2px{% endif %}; min-height: 2px; max-height: 100px;"
               title="{{ month.count }} items in {{ month.month }}">
            {% if month.count > 0 %}{{ month.count }}{% endif %}
          </div>
          <span class="text-xs text-gray-600 mt-2 text-center">{{ month.month|slice:":3" }}</span>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Recent Items -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
  <div class="px-6 py-4 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
        <i class="fas fa-clock text-amherst-purple"></i>
        Recent Items
      </h3>
      <a href="{% url 'staff:items' %}" class="text-amherst-purple hover:text-amherst-darkpurple font-medium text-sm flex items-center gap-1">
        View All
        <i class="fas fa-arrow-right text-xs"></i>
      </a>
    </div>
  </div>
  
  <div class="divide-y divide-gray-200">
    {% for item in recent %}
      <div class="p-6 hover:bg-gray-50 transition-colors duration-150">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                {% if item.status == 'Lost' %}bg-red-100 text-red-800
                {% elif item.status == 'Found' %}bg-green-100 text-green-800
                {% elif item.status == 'Returned' %}bg-blue-100 text-blue-800
                {% endif %}">
                {{ item.status }}
              </span>
              <a href="{% url 'staff:item_detail' item.pk %}" class="text-lg font-medium text-amherst-purple hover:text-amherst-darkpurple">
                #{{ item.pk }} · {{ item.name }}
              </a>
              {% if item.image_recognition_result %}
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                <i class="fas fa-robot mr-1"></i>
                AI
              </span>
              {% endif %}
            </div>
            <div class="mt-2 flex items-center gap-4 text-sm text-gray-600">
              <span class="flex items-center gap-1">
                <i class="fas fa-map-marker-alt"></i>
                {{ item.location|default:"No location" }}
              </span>
              <span class="flex items-center gap-1">
                <i class="fas fa-user"></i>
                {{ item.reported_by|default:"Anonymous" }}
              </span>
              <span class="flex items-center gap-1">
                <i class="fas fa-clock"></i>
                {{ item.date_reported|date:"M d, Y H:i" }}
              </span>
            </div>
          </div>
          <a href="{% url 'staff:item_detail' item.pk %}" class="ml-4 text-gray-400 hover:text-amherst-purple">
            <i class="fas fa-chevron-right"></i>
          </a>
        </div>
      </div>
    {% empty %}
      <div class="p-8 text-center">
        <i class="fas fa-inbox text-gray-300 text-4xl mb-4"></i>
        <p class="text-gray-500">No items yet.</p>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}